项目名称：全天候增强量化系统

项目简介：机器学习算法融合量化交易。

核心逻辑：通过宏观因子判断经济情况，中枢系统进行大类资产配置。每种细分资产内部采用合适的策略进行交易，同时风控系统等作为系统支持。举例：宏观因素策略判断现在处于美林时钟复苏期拐点，各种经济数据和特征以及政策、市场等情况分析后决定看多权益类，指数类，看空固收类，分配合适的资产组合仓位，然后对于权益指数，采用适合的transformer+cta+arima-garch策略，用transformer进行中期趋势判断，如果上涨，则发出看多信号，经由cta简单过滤后，由arima-garch模型预测一天的价格区间，当价格处于预测区间下沿附近，触发购买信号，接下来由操作系统进行购买，同时辅助风控系统判断交易金额，进行仓位风险控制。事件驱动模型则实时监控突发事件，比如突发政策利空，判断事件等级以及影响范围影响强度等，触发看空（卖出平仓）信号。另外如果有事件利好某种资产，比如突发战争利好黄金，则由事件模型提交信号给中枢系统，配置更多黄金资产，再由黄金资产对应的策略进行判断和买入。

初步规划策略：
总策略：宏观+事件驱动+风控 大类资产配置，强化学习模型
股票：因子投资 择股+择时 中低频交易 prophet transformer
指数：中期趋势跟随 tranformer(宏观因子注意力) arima-garch
期货：趋势动量跟随 Temporal Fusion Transformer（TFT）
外汇：套利 强化学习+宏观因子+XGBoost
固收：宏观/久期/凸性对冲 债券轮动 马尔科夫切换模型 Gradient Boosting with SHAP
大宗：宏观趋势、另类数据 CTA商品交易策略 garch（Jump Diffusion） rN-HiTS（分层时序预测）
期权：波动率套利 期权定价 garch/Heston
加密：高频动量策略 情绪 transformer + finbert(nlp)
风控：事件驱动监测+全局组合风控+各策略内部风控


项目构架：参考structure.txt


graph TD
    A[数据源] --> B{数据中台}
    B --> C[实时计算集群]
    B --> D[批处理集群]
    C --> E[决策引擎]
    D --> E
    E --> F[交易网关]
    F --> G[交易所]
    
    H[风控中心] -->|监控| E
    H -->|熔断指令| F
    I[策略研发] -->|回测| D
'''

难点
1. **复杂事件处理**
   - **难点**：L1级事件需<10ms响应
   - **方案**：使用Rust重写核心风控模块+Cython加速

2. **多资产回测**
   - **难点**：历史数据对齐与复权处理
   - **方案**：采用DuckDB+Arrow内存格式

3. **实时性能优化**
   - **难点**：高频数据的低延迟处理
   - **方案**：Apache Flink+Redis Streams

工具栈：
回测：backtrader
数据存储：DuckDB+MinIO
可视化：Plotly
部署：Docker+Kubernetes

开发流程：
1.先完成指数单资产的transformer-arima-garch策略回测，同时构建出数据pipeline，各模块接口设计，回测流程
2.搭建股票、固收资产策略，达到三资产组合
3.搭建核心：组合策略、事件驱动、风控
4.完成其他资产策略
5.搭建跨资产策略、全局风控，整合进核心
6.优化性能和各部分协调
7.部署，继续优化各部分

  

开发日志：
2025-3-4： 已经初步跑了一下arima-garch单模型的回测，初步确定了整个项目构架，接下来开始开发针对指数的transformer-cta-arima-garch模型

2025-3-16: 完成了基础架构搭建。数据可以从不同平台、不同数据类型、不同数据进行获取并且储存在parquet和redis里面，后续通过日期检查直接从里面取数据，避免了多次调取api被限制的情况。数据根据不同模型和资产进行预处理和特征工程。
模型部分，搭建了模型注册表和模型训练管理，用来管理模型的重新训练，当模型准确度下降或者经过一段时间后，自动获取新数据重新训练，然后把训练得到的参数和模型对象存在注册表里面，方便后面调取。模型部分暂时做了transformer和arima-garch。其中transformer加入了位置编码，窗口采取了200个数据，训练采取历史3000个窗口。transformer主要预测10日的累积对数收益率，收益率标准差，以及未来10天上涨下跌的日方向和10日总方向的一致比例。arima-garch主要采取autoarima拟合出来阶数，然后每日拟合新的arima-garch，garch用的（1，1）。指数策略方面，通过预测的10日收益率大于无风险收益率，发出买入信号，然后由每日计算的过去预测的准确率当作胜率，用未来预测的收益率除以止损确定盈亏比。计算凯利公式，然后通过预测的收益一致性进行调整。确定买入仓位。通过arima-garch模型计算一日的收益率均值和标准差，计算出来一日的预测区间。根据区间设置目标交易价格。根据预测的收益率设置止盈止损括号订单。订单一日有效期，未成交则取消。每日动态跟踪预测的准确率以及预测和真实收益率的相关系数，各自都计算长期和短期的数值。如果短期预测准确率急速下降，则触发模型熔断，立马加强已有仓位的止损，重新训练模型。同时接入风控系统，每日检查最大回撤，如果触发最大回撤则清仓。采用上证指数回测，2023年-2024年年化收益率7%左右比较稳定。
发现的问题，主要有两个：1.transformer模型预测的目标并没有很明确的趋势判断，目前10日收益率不足以更精确的判断趋势。2.backtrader本身订单管理混乱，无法精确对每一笔交易进行止损止盈，也无法精确追踪每一笔交易的盈亏。
接下来的工作：先增强bt框架的订单系统，用来支持FIFO和avg成本和仓位追踪，每一个trade支持绑定止盈止损。动态追踪每一笔trade的盈利情况。后续用真实的trade胜率来替代前面预测准确率。
然后具体有挑战性的工作，强化transformer模型，加入因果推断注意力机制，加入动态时间权重位置编码。考虑多个因子时间序列对未来价格的预测，也就是多维时间序列因果推断预测模型。把预测目标瞄准未来1-30天的价格区间。
订单系统增强：
新建Trade类别，最小的头寸单元，负责跟踪每个未平仓头寸的具体信息，包括开仓价格、仓位大小、止盈止损、未实现收益、已实现收益等。
增强Pisition，管理头寸集合和资产账户总头寸，实现FIFO方法和移动平均成本法跟踪成本，管理trade，并且支持逐日盯市
增强Broker，根据资产市场的限制（T+1、能否做空等），接收buy sell指令，判断开仓开始平仓，调用position和trade
